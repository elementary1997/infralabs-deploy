# Восстановление полной базы данных

Этот документ описывает процесс восстановления полной базы данных из основного проекта в `infralabs-deploy`.

## Обзор

В отличие от частичного экспорта (только курсы, модули, уроки, упражнения), полное восстановление включает:
- ✅ Всех пользователей и данные аутентификации
- ✅ Все курсы, модули, уроки, упражнения
- ✅ Весь прогресс пользователей (выполненные уроки, упражнения)
- ✅ Все достижения пользователей
- ✅ Все сессии sandbox
- ✅ Все уведомления и другие данные приложения

## Шаг 1: Экспорт базы данных из основного проекта

На сервере с основным проектом выполните:

```bash
cd /path/to/main/project

# Скопируйте скрипт экспорта (если его еще нет)
# Или используйте стандартный pg_dump:

docker exec infralabs_db pg_dump \
    -U infralabs_user \
    -d infralabs \
    --clean \
    --if-exists \
    --create \
    --format=plain \
    --no-owner \
    --no-privileges \
    > infralabs_full_db_$(date +%Y%m%d_%H%M%S).sql
```

Или используйте скрипт `scripts/export-full-db.sh` (если он скопирован в основной проект):

```bash
./scripts/export-full-db.sh
```

Скрипт создаст файл в директории `./backups/infralabs_full_db_YYYYMMDD_HHMMSS.sql`

## Шаг 2: Копирование файла на новый сервер

Скопируйте файл дампа на сервер с `infralabs-deploy`:

```bash
# Вариант 1: SCP
scp backups/infralabs_full_db_20250110_120000.sql user@new-server:/path/to/infralabs-deploy/backups/

# Вариант 2: Используя rsync
rsync -avz backups/infralabs_full_db_*.sql user@new-server:/path/to/infralabs-deploy/backups/

# Вариант 3: Через веб-интерфейс или другой способ
```

## Шаг 3: Импорт базы данных в infralabs-deploy

На сервере с `infralabs-deploy`:

```bash
cd /path/to/infralabs-deploy

# Убедитесь, что контейнер БД запущен
docker-compose up -d db

# Дождитесь готовности БД
docker-compose exec db pg_isready -U infralabs_user

# Импортируйте базу данных
./scripts/import-full-db.sh ./backups/infralabs_full_db_20250110_120000.sql
```

### Что делает скрипт импорта:

1. ✅ Проверяет наличие файла дампа
2. ✅ Убеждается, что контейнер БД запущен
3. ✅ **ВНИМАНИЕ**: Полностью удаляет существующую БД и создает новую
4. ✅ Восстанавливает все данные из дампа
5. ✅ Проверяет успешность импорта
6. ✅ Перезапускает web-сервис для применения изменений

## Предупреждения

⚠️ **ВАЖНО**: Полное восстановление базы данных **ЗАМЕНИТ** всю существующую базу данных в `infralabs-deploy`!

- Все существующие пользователи будут удалены
- Все существующие данные будут удалены
- Все курсы, модули и уроки будут заменены
- Все данные из основного проекта будут восстановлены

## Альтернатива: Частичный импорт

Если вам нужны только курсы, модули, уроки и упражнения (без пользователей и прогресса), используйте:

```bash
# В основном проекте
./scripts/export-data.sh

# В infralabs-deploy
./scripts/import-data.sh ./backups/infralabs_data_YYYYMMDD_HHMMSS.sql
```

См. документацию по частичному импорту в `scripts/import-data.sh`

## Проверка после импорта

После успешного импорта проверьте:

1. **База данных восстановлена:**
   ```bash
   docker-compose exec db psql -U infralabs_user -d infralabs -c "SELECT COUNT(*) FROM users;"
   docker-compose exec db psql -U infralabs_user -d infralabs -c "SELECT COUNT(*) FROM courses;"
   ```

2. **Приложение работает:**
   - Откройте http://localhost в браузере
   - Попробуйте войти с учетными данными из восстановленной БД

3. **Админ-панель доступна:**
   - Откройте http://localhost/admin/
   - Войдите с учетными данными администратора из восстановленной БД

## Устранение неполадок

### Ошибка: "Container not found"
```bash
# Убедитесь, что контейнеры запущены
docker-compose up -d db
docker-compose ps
```

### Ошибка: "Database connection failed"
```bash
# Проверьте, что БД готова к работе
docker-compose exec db pg_isready -U infralabs_user

# Проверьте логи
docker-compose logs db
```

### Ошибка: "Permission denied"
```bash
# Сделайте скрипт исполняемым
chmod +x scripts/import-full-db.sh
chmod +x scripts/export-full-db.sh
```

### Ошибка при импорте: "FATAL: database does not exist"
Скрипт автоматически создаст базу данных. Если это не происходит:
```bash
# Создайте БД вручную
docker-compose exec db psql -U postgres -c "CREATE DATABASE infralabs OWNER infralabs_user;"
```

### Частичный импорт: некоторые таблицы не восстановились
Проверьте логи импорта. Возможно, некоторые данные имеют зависимости, которые не были удовлетворены. В этом случае:
1. Проверьте, что все внешние ключи имеют соответствующие записи
2. Попробуйте импортировать только нужные таблицы вручную
3. Используйте частичный импорт через `import-data.sh` вместо полного

## Структура файлов

```
infralabs-deploy/
├── scripts/
│   ├── export-full-db.sh    # Экспорт полной БД (для использования в основном проекте)
│   └── import-full-db.sh    # Импорт полной БД (используется в infralabs-deploy)
├── backups/                  # Директория для файлов дампов (создается автоматически)
│   └── infralabs_full_db_*.sql
└── docs/
    └── DATABASE_RESTORE.md  # Этот файл
```

## Часто задаваемые вопросы

**Q: Можно ли импортировать БД без остановки приложения?**  
A: Скрипт автоматически останавливает все подключения к БД перед импортом, но рекомендуется остановить приложение для безопасности:
```bash
docker-compose stop web celery_worker celery_beat
# ... импорт БД ...
docker-compose start web celery_worker celery_beat
```

**Q: Сколько времени занимает импорт?**  
A: Зависит от размера БД. Обычно 1-5 минут для БД размером до 1 ГБ.

**Q: Можно ли откатить импорт?**  
A: Нет, если вы не создали резервную копию перед импортом. Всегда делайте бэкап перед импортом!

**Q: Можно ли импортировать БД с другого имени пользователя/БД?**  
A: Да, измените переменные в начале скрипта `import-full-db.sh`:
```bash
DB_NAME=your_db_name
DB_USER=your_db_user
```

## Поддержка

Если возникли проблемы:
1. Проверьте логи: `docker-compose logs db`
2. Проверьте размер файла дампа (не должен быть пустым)
3. Убедитесь, что версии PostgreSQL совместимы (рекомендуется 15.x)
