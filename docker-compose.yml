# Docker Compose –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Infra Labs
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –∏–∑ Docker Hub: elementary1997/infralabs-*

version: '3.8'

services:
  db:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-db:${VERSION:-latest}
    container_name: infralabs_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      - POSTGRES_DB=infralabs
      - POSTGRES_USER=infralabs_user
      # POSTGRES_PASSWORD –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º docker-compose
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U infralabs_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-redis:${VERSION:-latest}
    container_name: infralabs_redis
    command: >
      sh -c "
        redis-server --appendonly yes &
        sleep 2 &&
        redis-cli REPLICAOF NO ONE &&
        redis-cli CONFIG SET replica-read-only no &&
        wait
      "
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  web:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-web:${VERSION:-latest}
    container_name: infralabs_web
    command: >
      sh -c "
        echo 'üîÑ Running database migrations...' &&
        python manage.py migrate &&
        echo 'üë§ Creating/updating admin user...' &&
        python manage.py shell -c \"import os; from django.contrib.auth import get_user_model; User = get_user_model(); email = os.environ.get('ADMIN_EMAIL', 'admin@infralabs.com'); username = os.environ.get('ADMIN_USERNAME', 'admin'); password = os.environ.get('ADMIN_PASSWORD', 'admin123'); user, created = User.objects.get_or_create(email=email, defaults={'username': username}); user.is_superuser = True; user.is_staff = True; user.username = username; user.set_password(password); user.save(); print('‚úÖ Created admin user: ' + email) if created else print('‚úÖ Admin user ' + email + ' updated (password reset)')\" &&
        echo 'üì¶ Loading demo data...' &&
        python manage.py loaddata fixtures/demo_data.json 2>/dev/null || echo '‚ö†Ô∏è  Demo data already loaded or file not found' &&
        echo 'üìÅ Collecting static files...' &&
        python manage.py collectstatic --noinput &&
        echo 'üöÄ Starting Gunicorn...' &&
        gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120
      "
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  celery_worker:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-celery_worker:${VERSION:-latest}
    container_name: infralabs_celery_worker
    command: celery -A config worker -l info --concurrency=4
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - .env
    depends_on:
      - db
      - redis
      - web
    restart: unless-stopped

  celery_beat:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-celery_beat:${VERSION:-latest}
    container_name: infralabs_celery_beat
    command: celery -A config beat -l info
    env_file:
      - .env
    depends_on:
      - db
      - redis
      - web
    restart: unless-stopped

  nginx:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-nginx:${VERSION:-latest}
    container_name: infralabs_nginx
    volumes:
      - static_volume:/static
      - media_volume:/media
      - ssl_certs:/etc/nginx/ssl:ro
      - certbot_data:/var/www/certbot
    # –£–±–∏—Ä–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –ø–æ—Ä—Ç—ã - nginx –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Caddy
    # ports:
    #   - "80:80"
    #   - "${HTTPS_PORT:-443}:443"
    environment:
      - ENABLE_SSL=${ENABLE_SSL:-false}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/etc/nginx/ssl/cert.pem}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/etc/nginx/ssl/key.pem}
    networks:
      - default
    depends_on:
      - web
    restart: unless-stopped

  caddy:
    image: ${REGISTRY:-docker.io/elementary1997}/${IMAGE_PREFIX:-infralabs}-caddy:${VERSION:-latest}
    container_name: infralabs_caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # –î–ª—è HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - ACME_AGREE=${ACME_AGREE:-true}
    networks:
      - default
    depends_on:
      - nginx
    restart: unless-stopped

volumes:
  postgres_data:
  static_volume:
  media_volume:
  ssl_certs:
    driver: local
  certbot_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local

networks:
  default:
    name: infralabs_network
